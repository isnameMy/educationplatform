<!-- frontend/templates/student/module_assignment.html -->
{% extends "base.html" %}
{% block content %}

<div class="row">
  <div class="col-lg-8">
    <div class="card card-hover">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">{{ assignment.title }}</h3>
      </div>
      <div class="card-body">
        <p>{{ assignment.description | safe }}</p>

        {% if assignment.deadline %}
          <div class="alert alert-info" id="deadline-alert">
            <i class="bi bi-clock me-2"></i>
            <strong>Срок сдачи:</strong> {{ assignment.deadline.strftime('%d.%m.%Y %H:%M') }}
            <span id="countdown" class="ms-2 fw-bold"></span>
          </div>
          <script>
            const deadline = new Date('{{ assignment.deadline.isoformat() }}');
            const countdownElement = document.getElementById('countdown');
            const alertElement = document.getElementById('deadline-alert');

            function updateCountdown() {
              const now = new Date();
              const diff = deadline - now;

              if (diff <= 0) {
                countdownElement.textContent = 'Срок истёк!';
                alertElement.className = 'alert alert-danger'; // Красный цвет
                return;
              }

              const days = Math.floor(diff / (1000 * 60 * 60 * 24));
              const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

              countdownElement.textContent = `${days}д ${hours}ч ${minutes}м`;

              if (diff < 24 * 60 * 60 * 1000) { // Меньше 24 часов
                alertElement.className = 'alert alert-warning'; // Жёлтый цвет
              }
            }

            updateCountdown(); // Обновить сразу
            setInterval(updateCountdown, 60000); // Обновлять каждую минуту
          </script>
        {% endif %}

        <div class="mt-4">
          <h5>Требования</h5>
          <ul>
            <li>Код на Python</li>
            <li>Файл в формате <code>.py</code>, <code>.ipynb</code> или <code>.pdf</code></li>
            <li>Комментарии к ключевым решениям</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card card-hover">
      <div class="card-header">
        <h5>Ваша работа</h5>
      </div>
      <div class="card-body">
        {% if submission %}
          {% if submission.status == "pending" %}
            <div class="alert alert-warning">
              <i class="bi bi-hourglass-split me-2"></i>
              <strong>На проверке</strong>
              <p class="mb-0 mt-2">Отправлено: {{ submission.file_path.split('_')[-1].split('.')[0] }}</p>
            </div>
          {% elif submission.status == "reviewed" %}
            <div class="alert alert-success">
              <i class="bi bi-check-circle me-2"></i>
              <strong>Проверено! Оценка: {{ submission.grade }}/10</strong>
              {% if submission.feedback %}
                <p class="mt-2 mb-0">{{ submission.feedback }}</p>
              {% endif %}
            </div>

            <!-- Отображение проверенного кода с комментариями -->
            <div class="card mt-3">
              <div class="card-header">
                <h6>Код (с комментариями)</h6>
              </div>
              <div class="card-body p-0">
                <pre class="m-0 p-2 bg-light"><code id="code-display" class="language-python">{{ submission.code_content or "Код не загружен." }}</code></pre>
                <!-- Или, если выводим строку за строкой с подсветкой: -->
                {% if submission.code_lines %}
                <pre class="m-0 p-2 bg-light">
{% for line_num in range(1, submission.code_lines|length + 1) %}
<span id="line-{{ line_num }}" class="
  {% if submission.code_comments_by_line and line_num in submission.code_comments_by_line %}
    {% if submission.code_comments_by_line[line_num].type == "error" %}bg-danger text-white
    {% elif submission.code_comments_by_line[line_num].type == "warning" %}bg-warning
    {% else %}bg-info
    {% endif %}
  {% endif %}
">{{ "%3d"|format(line_num) }}: {{ submission.code_lines[line_num - 1] }}</span>
{% endfor %}
                </pre>
                {% endif %}
              </div>
            </div>

            <a href="/{{ submission.file_path }}" class="btn btn-outline-secondary w-100 mb-2">
              <i class="bi bi-file-earmark-arrow-down me-2"></i> Скачать работу
            </a>
          {% endif %}
        {% endif %}

        <!-- Форма сдачи -->
        {% if not submission or submission.status != "reviewed" %}
        <form
          hx-post="/student/submit/{{ assignment.id }}"
          hx-encoding="multipart/form-data"
          hx-target="#submit-result"
          hx-swap="innerHTML"
          class="mt-3"
        >
          <label class="form-label">Загрузите файл</label>
          <div class="dropzone" id="dropzone">
            <i class="bi bi-cloud-upload fs-1 mb-3 text-muted"></i>
            <p class="text-muted">Перетащите файл сюда<br><small>.py, .ipynb, .pdf</small></p>
            <input
              type="file"
              name="file"
              class="form-control d-none"
              id="file-input"
              accept=".py,.ipynb,.pdf"
              required
            >
            <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('file-input').click()">
              Выбрать файл
            </button>
          </div>

          <button type="submit" class="btn btn-success w-100 mt-3 btn-grad text-white">
            <i class="bi bi-send-check me-2"></i> Отправить на проверку
          </button>
        </form>
        {% endif %}

        <div id="submit-result" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // Drag-and-drop (остаётся как есть)
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('file-input');

  dropzone.addEventListener('click', () => fileInput.click());

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropzone.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, unhighlight, false);
  });

  function highlight() {
    dropzone.style.borderColor = '#4361ee';
    dropzone.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
  }

  function unhighlight() {
    dropzone.style.borderColor = '#adb5bd';
    dropzone.style.backgroundColor = '';
  }

  dropzone.addEventListener('drop', handleDrop, false);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    fileInput.files = files;
    dropzone.querySelector('p').textContent = files[0].name;
  }

  // Инициализация popover для строк с комментариями (ПОСЛЕ загрузки DOM)
  document.addEventListener('DOMContentLoaded', function() {
    {% if submission and submission.code_comments %}
      {% for comment in submission.code_comments %}
        const lineElement = document.getElementById('line-{{ comment.line }}');
        if (lineElement) {
          new bootstrap.Popover(lineElement, {
            title: 'Комментарий преподавателя',
            content: '{{ comment.message }}',
            placement: 'right',
            trigger: 'hover focus'
          });
        }
      {% endfor %}
    {% endif %}
  });

</script>

{% endblock %}